name: Weekly Closed Issues Report

on:
  schedule:
    # Runs every Sunday at 21:00 Bangkok time (14:00 UTC, Bangkok is UTC+7)
    - cron: '0 14 * * 0'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get closed issues from last week
        id: get_issues
        uses: actions/github-script@v7
        with:
          script: |
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: oneWeekAgo.toISOString(),
              per_page: 100
            });
            
            const closedIssues = issues.data.filter(issue => 
              !issue.pull_request && 
              new Date(issue.closed_at) >= oneWeekAgo
            );
            
            const totalClosed = closedIssues.length;
            
            let issuesList = closedIssues.map(issue => 
              `- #${issue.number}: ${issue.title}`
            ).join('\n');
            
            if (totalClosed === 0) {
              issuesList = 'No issues were closed this week.';
            }
            
            // Format dates as "26 Oct 2025"
            const formatDate = (date) => {
              const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                             'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              const d = new Date(date);
              return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
            };
            
            const report = {
              total: totalClosed,
              list: issuesList,
              period: `${formatDate(oneWeekAgo)} - ${formatDate(new Date())}`
            };
            
            return report;

      - name: Create email body
        id: email_body
        run: |
          cat << 'EOF' > email_body.txt
          Subject: Weekly Closed Features Report - ${{ github.event.repository.name }}

          Total Features Closed: ${{ fromJSON(steps.get_issues.outputs.result).total }}
          Period: ${{ fromJSON(steps.get_issues.outputs.result).period }}
          
          Closed Features:
          ${{ fromJSON(steps.get_issues.outputs.result).list }}
          
          EOF

      - name: Send email via Brevo SMTP
        env:
          BREVO_SMTP_LOGIN: ${{ secrets.BREVO_SMTP_LOGIN }}
          BREVO_SMTP_PASSWORD: ${{ secrets.BREVO_SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          sudo apt-get update
          sudo apt-get install -y mailutils ssmtp
          
          # Configure SSMTP
          sudo tee /etc/ssmtp/ssmtp.conf > /dev/null << EOF
          root=postmaster
          mailhub=smtp-relay.brevo.com:587
          hostname=github-actions
          AuthUser=$BREVO_SMTP_LOGIN
          AuthPass=$BREVO_SMTP_PASSWORD
          UseSTARTTLS=YES
          FromLineOverride=YES
          EOF
          
          # Send email
          cat email_body.txt | mail -s "Weekly Closed Issues Report - ${{ github.event.repository.name }}" \
            -a "From: $EMAIL_FROM" \
            $EMAIL_TO
